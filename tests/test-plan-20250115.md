# ğŸ§ª GUILD â€” Test Plan & Diagnostic Screen (Deliverables D & E)

**Generated:** 2025-01-15

---

## Deliverable D: Test Plan

### Smoke Flows (Manual Testing)

#### 1. Sign-Up Flow (Phone/SMS)
**Steps:**
1. Open app â†’ Navigate to sign-up
2. Enter phone number: `+1234567890`
3. Tap "Send SMS"
4. **Expected:** 
   - Expo Go: Mock SMS message with code `123456`
   - EAS Build: Real SMS delivered
5. Enter verification code
6. **Expected:** Account created, redirected to onboarding

**Validation:**
- âœ… SMS sent successfully
- âœ… Code verification works
- âœ… User profile created in Firestore
- âœ… Auth token generated

#### 2. Sign-In Flow
**Steps:**
1. Open app â†’ Navigate to sign-in
2. Enter existing credentials
3. Tap "Sign In"
4. **Expected:** User authenticated, redirected to home

**Validation:**
- âœ… Firebase auth token valid
- âœ… User profile loaded
- âœ… Navigation works

#### 3. Job List
**Steps:**
1. Navigate to jobs screen
2. **Expected:** List of jobs displayed

**Validation:**
- âœ… Firestore query succeeds
- âœ… Jobs render correctly
- âœ… Pagination works

#### 4. Open Chat
**Steps:**
1. Tap on a job â†’ Open chat
2. **Expected:** Chat screen opens, messages load

**Validation:**
- âœ… Chat listener connects
- âœ… Messages display correctly
- âœ… No permission errors

#### 5. Send Text Message
**Steps:**
1. Type message in chat input
2. Tap send
3. **Expected:** Message appears in chat

**Validation:**
- âœ… Message created in Firestore
- âœ… Real-time update works
- âœ… Message displays correctly

#### 6. Send Image Message
**Steps:**
1. Tap attachment icon â†’ Select image
2. **Expected:** Image uploads, message created

**Validation:**
- âœ… Image uploaded to Storage
- âœ… ContentType correct (`image/jpeg`)
- âœ… Message created with URL
- âœ… Image displays in chat

#### 7. Send Video Message
**Steps:**
1. Tap attachment icon â†’ Record video
2. **Expected:** Video uploads, thumbnail generated

**Validation:**
- âœ… Video uploaded (`video/mp4`)
- âœ… Thumbnail generated (`image/jpeg`)
- âœ… Message created with URLs
- âœ… Video plays correctly

#### 8. Send File Message
**Steps:**
1. Tap attachment icon â†’ Select file
2. **Expected:** File uploads, message created

**Validation:**
- âœ… File uploaded with correct contentType
- âœ… Message created with URL
- âœ… File downloadable

#### 9. Presence/Typing Indicators
**Steps:**
1. Open chat with another user
2. Start typing
3. **Expected:** Other user sees typing indicator

**Validation:**
- âœ… Typing indicator appears
- âœ… TTL expires after 4.5s
- âœ… Indicator clears on unmount

#### 10. Mark Read
**Steps:**
1. Receive unread message
2. Open chat
3. **Expected:** Message marked as read

**Validation:**
- âœ… `readBy` field updated
- âœ… Unread count decreases
- âœ… Badge updates

#### 11. Push Token Registration
**Steps:**
1. Grant notification permission
2. **Expected:** Token registered with backend

**Validation:**
- âœ… Permission granted
- âœ… Token generated
- âœ… POST `/notifications/register-token` succeeds
- âœ… Token stored in Firestore

#### 12. Wallet Fetch
**Steps:**
1. Navigate to wallet screen
2. **Expected:** Wallet balance displayed

**Validation:**
- âœ… GET `/api/v1/payments/wallet/:userId` succeeds
- âœ… Balance displayed correctly
- âœ… Demo mode check works

---

### Automated Tests

#### Unit Tests

**File:** `tests/unit/presenceTTL.test.ts`
```typescript
describe('PresenceService TTL', () => {
  it('should expire typing indicator after 4.5s', () => {
    const timestamp = Date.now() - 5000; // 5 seconds ago
    expect(isTypingFresh(timestamp)).toBe(false);
  });
  
  it('should keep typing indicator fresh within 4.5s', () => {
    const timestamp = Date.now() - 3000; // 3 seconds ago
    expect(isTypingFresh(timestamp)).toBe(true);
  });
});
```

**File:** `tests/unit/messageMapper.test.ts`
```typescript
describe('Message Mapper', () => {
  it('should handle malformed message data', () => {
    const malformed = { id: '123', text: null };
    const mapped = mapMessage(malformed);
    expect(mapped.text).toBe('');
  });
});
```

**File:** `tests/unit/styleGuards.test.ts`
```typescript
describe('Style Guards', () => {
  it('should convert ViewStyle correctly', () => {
    const style = { width: 100, height: 100 };
    const converted = asViewStyle(style);
    expect(converted).toBeInstanceOf(Array);
  });
});
```

#### Integration Tests

**File:** `tests/integration/uploadFlow.test.ts`
```typescript
describe('Upload Flow', () => {
  it('should upload file before creating message', async () => {
    const chatId = 'test-chat';
    const fileUri = 'file://test.jpg';
    
    // Mock Storage
    const uploadSpy = jest.spyOn(storage, 'uploadBytes');
    const urlSpy = jest.spyOn(storage, 'getDownloadURL');
    
    await chatFileService.uploadImageMessage(chatId, fileUri, 'msg1');
    
    // Verify upload happens first
    expect(uploadSpy).toHaveBeenCalledBefore(urlSpy);
    
    // Verify message creation happens after
    const createMessageSpy = jest.spyOn(chatService, 'sendMessage');
    expect(createMessageSpy).toHaveBeenCalledAfter(urlSpy);
  });
});
```

**File:** `tests/integration/chatListener.test.ts`
```typescript
describe('Chat Listener', () => {
  it('should maintain last good state on error', async () => {
    const chatId = 'test-chat';
    const messages: Message[] = [{ id: '1', text: 'Hello' }];
    
    // Simulate successful initial load
    const callback = jest.fn();
    const unsubscribe = chatService.listenToMessages(chatId, callback);
    
    await waitFor(() => {
      expect(callback).toHaveBeenCalledWith(messages);
    });
    
    // Simulate error
    mockFirestoreError();
    
    // Verify last good state maintained
    await waitFor(() => {
      expect(callback).toHaveBeenLastCalledWith(messages);
    });
    
    unsubscribe();
  });
});
```

#### E2E Checklist (Expo Dev Build)

**Prerequisites:**
- EAS Dev Build installed on device
- Backend running on Render
- Test user account created

**Test Checklist:**
- [ ] Sign up with phone number
- [ ] Receive real SMS code
- [ ] Verify code successfully
- [ ] Complete onboarding
- [ ] Browse jobs
- [ ] Open chat
- [ ] Send text message
- [ ] Send image message
- [ ] Send video message
- [ ] Receive push notification
- [ ] Check wallet balance
- [ ] Test presence/typing
- [ ] Test RTL layout (Arabic)

---

### Validation Script

**File:** `scripts/validate.sh`

```bash
#!/bin/bash

echo "ğŸ” GUILD Validation Script"
echo "=========================="

# Check TypeScript
echo "ğŸ“ Checking TypeScript..."
npm run typecheck
if [ $? -eq 0 ]; then
  echo "âœ… TypeScript check passed"
else
  echo "âŒ TypeScript check failed"
  exit 1
fi

# Check linting
echo "ğŸ” Checking ESLint..."
npm run lint
if [ $? -eq 0 ]; then
  echo "âœ… Linting passed"
else
  echo "âŒ Linting failed"
  exit 1
fi

# Run unit tests
echo "ğŸ§ª Running unit tests..."
npm run test:unit
if [ $? -eq 0 ]; then
  echo "âœ… Unit tests passed"
else
  echo "âŒ Unit tests failed"
  exit 1
fi

# Check environment variables
echo "ğŸ” Checking environment variables..."
if [ -z "$EXPO_PUBLIC_FIREBASE_API_KEY" ]; then
  echo "âš ï¸  EXPO_PUBLIC_FIREBASE_API_KEY not set"
fi

# Check Firebase config
echo "ğŸ”¥ Checking Firebase config..."
node -e "const config = require('./src/config/firebase.tsx'); console.log('Firebase project:', config.firebaseConfig.projectId)"

echo "âœ… All checks passed!"
```

---

## Deliverable E: Diagnostic Screen

**File:** `src/app/(modals)/diagnostic.tsx` (Already exists, but needs enhancement)

### Current Diagnostic Screen Features

âœ… Presence connect/disconnect test  
âœ… Firestore read/write test  
âœ… Payment `/demo-mode` test  
âœ… Push permission + token test  
âœ… Camera/mic permission test

### Enhanced Diagnostic Screen

**Additions Needed:**

1. **Backend Connection Test**
   - Test `/api/v1/payments/demo-mode` endpoint
   - Test `/api/v1/payments/wallet/:userId` endpoint
   - Display response time and status

2. **Socket Connection Test**
   - Test socket.io connection
   - Display connection status
   - Test reconnection

3. **Firestore Rules Test**
   - Test read/write permissions
   - Test participant queries
   - Display permission errors

4. **Upload Flow Test**
   - Test image upload
   - Test video upload
   - Verify contentType

5. **Chat Listener Test**
   - Test defensive listener
   - Simulate error
   - Verify last good state

6. **GlobalChatNotificationService Test**
   - Test listener setup
   - Test error handling
   - Verify service continues on error

### Diagnostic Screen UI

```typescript
interface DiagnosticTest {
  name: string;
  status: 'pending' | 'running' | 'success' | 'error';
  message: string;
  timestamp: Date;
  details?: any;
}

const tests: DiagnosticTest[] = [
  {
    name: 'Presence',
    status: 'success',
    message: 'Connected successfully',
    timestamp: new Date(),
    details: { userId: 'user123' }
  },
  // ... more tests
];
```

### Expected Output

```
ğŸ” GUILD Diagnostic Screen
==========================

âœ… Presence           Connected      (2025-01-15 10:30:00)
âœ… Firestore          Read/Write OK  (2025-01-15 10:30:01)
âœ… Payment            Demo mode: false (2025-01-15 10:30:02)
âœ… Push               Token registered (2025-01-15 10:30:03)
âœ… Camera             Permissions granted (2025-01-15 10:30:04)
âœ… Backend            Connected (200ms) (2025-01-15 10:30:05)
âœ… Socket             Connected (2025-01-15 10:30:06)
âœ… Firestore Rules    All checks passed (2025-01-15 10:30:07)
âœ… Upload Flow        Image upload OK (2025-01-15 10:30:08)
âœ… Chat Listener      Defensive mode active (2025-01-15 10:30:09)
âœ… GlobalChatNotif    Service running (2025-01-15 10:30:10)

All tests passed! âœ…
```

---

## Test Execution

### Manual Test Execution

1. **Run Smoke Flows:**
   ```bash
   # Follow smoke flow checklist above
   ```

2. **Run Diagnostic Screen:**
   ```bash
   # Navigate to /diagnostic in app
   # Tap "Run All Tests"
   # Review results
   ```

### Automated Test Execution

```bash
# Run all tests
npm run test

# Run unit tests only
npm run test:unit

# Run integration tests
npm run test:integration

# Run E2E tests (requires Dev Build)
npm run test:e2e
```

### Validation Script Execution

```bash
# Make executable
chmod +x scripts/validate.sh

# Run validation
./scripts/validate.sh
```

---

**Status:** Test Plan & Diagnostic Screen complete âœ…















