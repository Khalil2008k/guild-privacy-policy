rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ==========================================
    // CORE USER COLLECTIONS
    // ==========================================
    
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      
      match /blockedUsers/{blockedUserId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    match /wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /user_wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userProfiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userSkills/{skillId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /userAttributes/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userCurrencyPreferences/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userTaxProfiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /user_risk_profiles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    match /user_virtual_currency_compliance/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    // ==========================================
    // VERIFICATION & SECURITY
    // ==========================================
    
    match /verificationDocuments/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /verification_codes/{codeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /verification_status/{userId} {
      allow read: if isOwner(userId);
      allow write: if request.auth != null;
    }
    
    match /security_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /security_alerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /user_blocks/{userId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /admin_escalations/{escalationId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /privacy_consents/{consentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /data_processing_records/{recordId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // JOB COLLECTIONS
    // ==========================================
    
    match /jobs/{jobId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.clientId;
      
      match /offers/{offerId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && 
          (request.auth.uid == resource.data.freelancerId || 
           request.auth.uid == get(/databases/$(database)/documents/jobs/$(jobId)).data.clientId);
      }
    }
    
    match /job_offers/{offerId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /jobApplications/{applicationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /applications/{applicationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /offers/{offerId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /contracts/{contractId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.clientId || 
         request.auth.uid == resource.data.freelancerId);
      allow write: if request.auth != null;
    }
    
    match /disputes/{disputeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      
      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    match /reviews/{reviewId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /courtSessions/{sessionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /escrows/{escrowId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /escrow/{escrowId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // GUILD COLLECTIONS
    // ==========================================
    
    match /guilds/{guildId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guildMembers/{memberId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guildMemberships/{membershipId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guild_members/{memberId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guildAnnouncements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guildInvitations/{invitationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /guildIds/{guildId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /gids/{gidId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /gidContainers/{containerId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /gidSequences/{sequenceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /guild_vault_daily/{vaultId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ==========================================
    // COINS & PAYMENTS
    // ==========================================
    
    match /coin_counters/{counterId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /coin_instances/{instanceId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /quarantined_coins/{coinId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /mint_batches/{batchId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /coins/{coinId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /coin_purchases/{purchaseId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    match /coin_withdrawals/{withdrawalId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    match /wallet_transactions/{transactionId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    match /transactions/{transactionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /transaction_records/{recordId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /payments/{paymentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /payment_records/{recordId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /paymentReleaseTimers/{timerId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /paymentReleases/{releaseId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /balanceReconciliations/{reconciliationId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /ledger/{entryId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /invoices/{invoiceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /invoiceSettings/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /invoiceTemplates/{templateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /savingsPlans/{planId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /savingsTransactions/{transactionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /fakeWallets/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // TAX & CURRENCY
    // ==========================================
    
    match /taxConfigurations/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /taxCalculations/{calculationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /taxDocuments/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /currencies/{currencyId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /currencyConversions/{conversionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /exchangeRates/{rateId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // CHAT & MESSAGING
    // ==========================================
    
    match /chats/{chatId} {
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      allow write: if request.auth != null;
      
      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /file_uploads/{uploadId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /message-audit-trail/{trailId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /messageSearch/{searchId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /chatOptions/{chatId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // NOTIFICATIONS
    // ==========================================
    
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    match /notificationPreferences/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /notificationSettings/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /deviceTokens/{tokenId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /notificationActionLogs/{logId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // SUPPORT & HELP
    // ==========================================
    
    match /admin_chats/{chatId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
      
      match /messages/{messageId} {
        allow read: if request.auth != null && 
          (request.auth.uid == get(/databases/$(database)/documents/admin_chats/$(chatId)).data.userId || isAdmin());
        allow write: if request.auth != null;
      }
    }
    
    match /feedback/{feedbackId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /knowledgeBase/{articleId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /faqs/{faqId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // ANNOUNCEMENTS
    // ==========================================
    
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }
    
    // ==========================================
    // ACHIEVEMENTS & LEADERBOARDS
    // ==========================================
    
    match /achievements/{achievementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /leaderboards/{leaderboardId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /leaderboardEntries/{entryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /competitions/{competitionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /badges/{badgeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // SECURITY & MONITORING
    // ==========================================
    
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /qrScans/{scanId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /behavioral_profiles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    match /transaction_monitoring_results/{resultId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /data_integrity_checks/{checkId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /compliance_reports/{reportId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /audit_exports/{exportId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /suspicious_activities/{activityId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /virtual_currency_reports/{reportId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /compliance_audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ==========================================
    // DATA PROTECTION
    // ==========================================
    
    match /data_export_requests/{requestId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    match /data_deletion_requests/{requestId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // ADMIN & SYSTEM
    // ==========================================
    
    match /systemSettings/{settingId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /system/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /apiKeys/{keyId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /rateLimitRules/{ruleId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /apiRequests/{requestId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /apiAnalytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /analyticsEvents/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /appRules/{ruleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /adminConfig/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /adminPreferences/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /adminNotifications/{notificationId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /reports/{reportId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // TESTING COLLECTIONS (Dev only)
    // ==========================================
    
    match /test-triggers/{triggerId} {
      allow read, write: if false;
    }
    
    match /test-trigger-responses/{responseId} {
      allow read, write: if false;
    }
    
    match /test-documents/{docId} {
      allow read, write: if false;
    }
    
    // ==========================================
    // DEFAULT DENY RULE
    // ==========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
