rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isParticipant(chatId) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
    
    // ==========================================
    // CORE USER COLLECTIONS
    // ==========================================
    
    match /users/{userId} {
      // Allow authenticated users to read any user profile (for search)
      allow read: if request.auth != null;
      // Only owner can write
      allow write: if isOwner(userId);
      
      match /blockedUsers/{blockedUserId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    match /wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /user_wallets/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userProfiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userSkills/{skillId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /userAttributes/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userCurrencyPreferences/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /userTaxProfiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /user_risk_profiles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    match /user_virtual_currency_compliance/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    // ==========================================
    // VERIFICATION & SECURITY
    // ==========================================
    
    match /verificationDocuments/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /verification_codes/{codeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /verification_status/{userId} {
      allow read: if isOwner(userId);
      allow write: if request.auth != null;
    }
    
    match /security_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /security_alerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /user_blocks/{userId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /admin_escalations/{escalationId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    match /privacy_consents/{consentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /data_processing_records/{recordId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // JOB COLLECTIONS
    // ==========================================
    
    match /jobs/{jobId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /guilds/{guildId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // CHAT COLLECTIONS - FIXED FOR PERMISSION ERRORS
    // ==========================================
    
    match /chats/{chatId} {
      // Allow authenticated users to read chats where they are participants
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Allow authenticated users to write chats where they are participants
      allow write: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Admin can read/write all chats
      allow read, write: if isAdmin();
      
      // ===== MESSAGES SUBCOLLECTION =====
      match /messages/{messageId} {
        // Participants can read/write messages
        allow read: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow write: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Admin can read/write all messages
        allow read, write: if isAdmin();
      }
    }
    
    // ==========================================
    // NOTIFICATION COLLECTIONS
    // ==========================================
    
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /user_notifications/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ==========================================
    // ADMIN COLLECTIONS
    // ==========================================
    
    match /admin/{adminId} {
      allow read, write: if isAdmin();
    }
    
    match /admin_logs/{logId} {
      allow read, write: if isAdmin();
    }
    
    match /admin_settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // ==========================================
    // SYSTEM COLLECTIONS
    // ==========================================
    
    match /system/{systemId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /app_config/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /feature_flags/{flagId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // PAYMENT COLLECTIONS
    // ==========================================
    
    match /payments/{paymentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /transactions/{transactionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /payment_methods/{methodId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // ANALYTICS COLLECTIONS
    // ==========================================
    
    match /analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if request.auth != null;
    }
    
    match /user_analytics/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if request.auth != null;
    }
    
    // ==========================================
    // DEFAULT DENY ALL
    // ==========================================
    
    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
